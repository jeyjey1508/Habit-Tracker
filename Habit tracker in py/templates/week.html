{% extends "base.html" %}
{% block title %}Woche - Habit Tracker{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header row-between">
    <div>
      <h1 class="h1">Wochenübersicht</h1>
      <p class="muted">
        Zeitraum:
        {% if stats.start_date is defined and stats.end_date is defined %}
          {{ stats.start_date.strftime('%d.%m.%Y') }} – {{ stats.end_date.strftime('%d.%m.%Y') }}
        {% else %}
          KW {{ week }} {{ year }}
        {% endif %}
      </p>
    </div>

    <div class="month-nav">
      <a id="prevLink" class="btn-secondary" href="#" aria-label="vorherige Woche">←</a>
      <span class="month-label" id="weekLabel">KW {{ week }} {{ year }}</span>
      <a id="nextLink" class="btn-secondary" href="#" aria-label="nächste Woche">→</a>
    </div>
  </div>

  <div class="grid-2">
    <div class="card-sub">
      <h3 class="h3">Tabelle</h3>

      <div class="table-responsive">
        <table class="week-table" role="table" aria-label="Gewohnheiten pro Tag">
          <thead>
            <tr role="row">
              <th scope="col">Gewohnheit</th>
              {% for wd in weekdays %}
                <th scope="col" class="weekday {{ 'today' if wd.is_today }}">{{ wd.short }}<br>{{ wd.day }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for s in stats['habits'] %}
            <tr class="habit-row" data-habit-id="{{ s['habit'].id }}">
              <td>
                <strong>{{ s['habit'].name }}</strong>
                {% if s['habit'].category %}<div class="muted">{{ s['habit'].category }}</div>{% endif %}
              </td>

              {% for wd in weekdays %}
                {# wd.date kann ein date-Objekt sein — benutze isoformat() für data-attribute #}
                {% set date_iso = wd.date.isoformat() %}
                {% set done = calendar_data.get(s['habit'].id, {}).get(date_iso, False) %}
                {# WICHTIG: pro-Zelle eine .habit-item erzeugen, damit toggleHabit (button.closest('.habit-item')) funktioniert #}
                <td class="week-cell habit-item {{ 'completed' if done }}" data-date="{{ date_iso }}" data-habit-id="{{ s['habit'].id }}">
                  <button
                    class="habit-checkbox"
                    onclick="toggleHabit({{ s['habit'].id }}, '{{ date_iso }}', this)"
                    onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); this.click();}"
                    aria-label="{{ s['habit'].name }} {{ 'erledigt' if done else 'nicht erledigt' }}"
                    aria-pressed="{{ 'true' if done else 'false' }}"
                    title="{{ 'Erledigt' if done else 'Nicht erledigt' }}">
                    <span class="checkbox-visual" aria-hidden="true">✓</span>
                  </button>
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card-sub">
      <h3 class="h3">Statistiken</h3>
      <p class="muted">Gesamterfüllung: <strong id="overallRate">{{ stats['overall_rate']|round(1) }}%</strong></p>

      <ul class="stats-list">
        {% for s in stats['habits'] %}
        <li class="stat-item">
          <div class="stat-main">
            <strong>{{ s['habit'].name }}</strong>
            {% if s['habit'].category %}<span class="badge">{{ s['habit'].category }}</span>{% endif %}
          </div>
          <div class="stat-sub">
            Rate: {{ s['rate']|round(1) }}% · Streak: {{ s['current_streak'] }} · Max: {{ s['longest_streak'] }} · Trend:
            <span class="{{ 'pos' if s['trend']>=0 else 'neg' }}">{{ '%+.1f'|format(s['trend']) }}%</span>
          </div>
          <div class="mini-heat" data-habit-id="{{ s['habit'].id }}"></div>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  // WEEKDAYS erzeugen wir per Template, damit Datumsobjekte sicher als ISO-Strings kommen
  const YEAR = {{ year|tojson }};
  const WEEK = {{ week|tojson }};
  const CALENDAR_DATA = {{ calendar_data|tojson }};
  const OVERALL = {{ stats['overall_rate']|tojson }};

  const WEEKDAYS = [
    {% for wd in weekdays %}
    {
      date: "{{ wd.date.isoformat() }}",
      name: "{{ wd.name }}",
      short: "{{ wd.short }}",
      day: {{ wd.day }},
      is_today: {{ 'true' if wd.is_today else 'false' }}
    }{{ "," if not loop.last else "" }}
    {% endfor %}
  ];

  // Label aktualisieren
  (function initLabel(){
    const lbl = document.getElementById('weekLabel');
    if (lbl) lbl.textContent = `KW ${String(WEEK).padStart(2,'0')} ${YEAR}`;
  })();

  // Navigation (Vor/Zurück in Wochen)
  function getISOWeekAndYearFromDate(d) {
    // expects a Date object in UTC
    const date = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
    // shift to Thursday to determine ISO week-numbering year
    date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    return { year: date.getUTCFullYear(), week: weekNo };
  }

  (function initNav(){
    if (!WEEKDAYS.length) return;
    const start = new Date(WEEKDAYS[0].date + 'T00:00:00Z');
    const prev = new Date(start); prev.setUTCDate(prev.getUTCDate() - 7);
    const next = new Date(start); next.setUTCDate(next.getUTCDate() + 7);
    const p = getISOWeekAndYearFromDate(prev);
    const n = getISOWeekAndYearFromDate(next);
    const prevLink = document.getElementById('prevLink');
    const nextLink = document.getElementById('nextLink');
    if (prevLink) prevLink.href = `/week/${p.year}/${p.week}`;
    if (nextLink) nextLink.href = `/week/${n.year}/${n.week}`;
  })();

  // Mini-Heatmaps pro Habit
  function makeHeat(container, dataMap) {
    const grid = document.createElement('div');
    grid.className = 'heat-grid';
    for (let i = 0; i < WEEKDAYS.length; i++) {
      const ds = WEEKDAYS[i].date;
      const hit = Boolean((dataMap || {})[ds]);
      const cell = document.createElement('div');
      cell.className = 'heat-cell ' + (hit ? 'hit' : '');
      cell.title = `${ds} - ${hit ? '✓' : '—'}`;
      grid.appendChild(cell);
    }
    container.replaceChildren(grid);
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.mini-heat').forEach(div => {
      const id = div.getAttribute('data-habit-id');
      makeHeat(div, CALENDAR_DATA[id] || {});
    });

    // Overall Rate safety
    const overallEl = document.getElementById('overallRate');
    if (overallEl) overallEl.textContent = Number(OVERALL).toFixed(1) + '%';
  });
</script>
{% endblock %}
